# üóÑÔ∏è Database Structure

**Version:** 5.0
**üìÖ Date:** 2025-03-24
**üë§ Author:** Bo Joel Kvarnsmyr
**üîÑ Last Revised By:** Bo Joel Kvarnsmyr

## üéØ Purpose & Overview

The database structure for Inner Journey is designed to store and manage user data securely, scalably, and efficiently via Firebase `Firestore`. It supports the app's core features:

-   üë§ **Personal Profiling:** Based on astrology, numerology, and number-based answers.
-   ‚úçÔ∏è **Logging of Exercises:** Includes `"activations"`, live interactions, and AI-based analyses.
-   ü§ù **Future Features:** Social interactions and coaching tools.

> **üìù NOTE:** Currently, Firebase `Firestore` is *not* implemented in the backend. Data storage is temporarily handled in an in-memory dictionary (`call_status`). However, the structure below is designed to fit `Firestore` when it is implemented.

For a broader overview of the project, see [`Project Description: Inner Journey`](#).

## üóÇÔ∏è Collections & Fields (Firestore Structure)

Below are the planned collections and their fields in `Firestore`.

### üë§ Collection: `users`

**Description:** Main collection for user profiles.

**Document ID:** User's UID (planned from `Firebase Auth`, currently `userId` generated by the backend).

**Fields:**

-   `userId`: `String` - Unique identifier (e.g., `"abc123"`).
-   `birthDate`: `String` - Birth date in ISO 8601 format (e.g., `"1990-05-15"`). Used for astrology and numerology.
-   `birthTime`: `String` - Birth time (e.g., `"14:30"`). Used for astrology (ascendant).
-   `birthLocation`: `String` - Birth location (e.g., `"Stockholm, Sweden"`). Used for astrology (ascendant).
-   `phoneNumber`: `String` - Verified phone number (e.g., `"+447418631211"`).
-   `createdAt`: `Timestamp` - Timestamp for when the user registered.
-   `uiStyle`: `String` - User's chosen UI theme (e.g., `"clean"`, `"technical"`, `"professional"`).
-   `focusArea`: `String` - Primary goal from onboarding (e.g., `"stress_relief"`, `"focus"`, `"self_awareness"`).
-   `timeCommitment`: `Number` - Desired time per day in minutes (e.g., `5`, `15`, `30`).
-   `personalityType`: `Object` - Generated personality profile:
    -   `traits`: `Array` - Traits based on number questions (e.g., `["introvert", "intuitive"]`).
    -   `astroSign`: `String` - Sun sign from `birthDate` (e.g., `"Taurus"`).
    -   `lifePathNumber`: `Number` - Life path number from `birthDate` (numerology) (e.g., `7`).
-   `neuroTendencies`: `Object` - Indicators based on onboarding answers:
    -   `adhdScore`: `Number` - Score (0-10) based on answers (e.g., routine preference).
    -   `autismScore`: `Number` - Score (0-10) based on answers (e.g., focus/stimuli).
-   `wellbeingFlags`: `Object` - Well-being markers based on onboarding answers:
    -   `depressionRisk`: `Boolean` - Flag from answers about hopelessness.
    -   `suicideRisk`: `Boolean` - Flag from answers about life change.
-   `answers`: `Array` - Raw data from onboarding questions (e.g., `[{"q1": "Draining"}, {"q2": "One task"}]`).

**üí° Flexibility:** Can be extended with fields such as `moonSign`, `risingSign`, `progressLevel`, or `achievementPoints`.

### üí™ Collection: `exercises`

**Description:** Predefined exercises (`activations`) in the app.

**Document ID:** Unique ID for the exercise (e.g., `"hemisync_001"`, `"silent_eye_contact_001"`).

**Fields:**

-   `title`: `String` - Exercise title (e.g., `"The Sound of You"`, `"Silent Eye Contact Live"`).
-   `type`: `String` - Type of exercise (e.g., `"audio"`, `"video+text"`, `"live_interaction"`, `"ai_assessment"`).
-   `description`: `String` - Short introduction (e.g., `"A 10-min guided Hemisync meditation"`).
-   `duration`: `Number` - Approximate duration in minutes (e.g., `10`, `5`, `3`).
-   `mediaUrl`: `String` - Link to media file in Firebase Storage (e.g., audio file, video). Can be `null` for live or AI exercises.
-   `category`: `String` - Category for the exercise (e.g., `"awareness"`, `"social"`, `"physical"`).

**üí° Flexibility:** Can be extended with fields such as `difficulty`, `tags`, or `prerequisites`.

### üìù Collection: `user_exercises`

**Description:** Logs users' progress and reflections linked to specific exercises.

**Document ID:** Combination of user UID and exercise ID (e.g., `"abc123_hemisync_001"`).

**Fields:**

-   `userId`: `String` - Reference to the `users` collection.
-   `exerciseId`: `String` - Reference to the `exercises` collection.
-   `completedAt`: `Timestamp` - Timestamp for when the exercise was completed.
-   `log`: `Object` - User's reflection and log data:
    -   `text`: `String` (optional) - Written reflection (e.g., `"Felt connected after eye contact"`).
    -   `audioUrl`: `String` (optional) - Link to audio log in Firebase Storage (planned).
    -   `videoUrl`: `String` (optional) - Link to video log in Firebase Storage (planned).
    -   `aiAnalysis`: `Object` (optional) - Results from AI analysis (e.g., balance score, report).
-   `sessionId`: `String` (optional) - Reference to `live_sessions` if the exercise was a live interaction.
-   `status`: `String` - Status of the exercise (e.g., `"in_progress"`, `"completed"`).

**üí° Flexibility:** Can be extended with fields such as `rating`, `moodBefore`, or `moodAfter`.

### üë• Collection: `live_sessions`

**Description:** Manages data for live interactions between users (e.g., for the exercise `"Silent Eye Contact Live"`).

**Document ID:** Unique ID for the session (e.g., `"live123"`).

**Fields:**

-   `participants`: `Array` - List of `userId`s for participating users (e.g., `["abc123", "uid456"]`).
-   `startTime`: `Timestamp` - When the session started.
-   `endTime`: `Timestamp` - When the session ended.
-   `exerciseId`: `String` - Reference to the associated exercise in `exercises` (e.g., `"silent_eye_contact_001"`).
-   `reflections`: `Array` - Collection of participants' reflections after the session:
    -   `userId`: `String` - User's ID.
    -   `text`: `String` - User's written reflection (e.g., `"Felt a sense of calm"`).

**üí° Flexibility:** Can be extended with fields such as `sessionRecording` (link to recording) or `technicalStatus`.

### ‚úÖ Collection: `consents`

**Description:** Stores GDPR consents for traceability.

**Document ID:** User's UID (`userId`).

**Fields:**

-   `userId`: `String` - Reference to the `users` collection.
-   `agreedAt`: `Timestamp` - When the consent was given.
-   `version`: `String` - Version of terms of service/privacy policy that was accepted (e.g., `"v1.0"`).

### üìû Collection: `sessions`

**Description:** Manages temporary call status (replaces the current in-memory `call_status` dictionary when `Firestore` is implemented).

**Document ID:** Unique `sessionId` (e.g., `"abc123"`).

**Fields:**

-   `sessionId`: `String` - Unique identifier for the session.
-   `callStatus`: `Object` - Current status of the call (e.g., `{"verificationCode": "123456", "status": "active"}`).
-   `userId`: `String` - Reference to the associated user in `users`.

## üìä Example Data

Below are examples of what data might look like in the different collections.

### `users`

```json
{
  "userId": "firebase-uid-123",
  "birthDate": "1988-12-06",
  "birthTime": "14:30",
  "birthLocation": "Stockholm, Sweden",
  "phoneNumber": "+46701234567",
  "createdAt": "2025-03-24T10:00:00Z",
  "uiStyle": "clean",
  "focusArea": "stress_relief",
  "timeCommitment": 15,
  "personalityType": {
    "traits": ["introvert", "intuitive"],
    "astroSign": "Taurus",
    "lifePathNumber": 7
  },
  "neuroTendencies": {
    "adhdScore": 3,
    "autismScore": 2
  },
  "wellbeingFlags": {
    "depressionRisk": false,
    "suicideRisk": false
  },
  "answers": [{"q1": "Draining"}, {"q2": "One task"}]
}
```

### `exercises`

```json
{
  "exerciseId": "hemisync_001",
  "title": "The Sound of You",
  "type": "audio",
  "description": "A 10-min guided Hemisync meditation",
  "duration": 10,
  "mediaUrl": "[link to audio file, planned]",
  "category": "awareness"
}
```

### `user_exercises`

```json
{
  "userExerciseId": "abc123_hemisync_001",
  "userId": "firebase-uid-123",
  "exerciseId": "hemisync_001",
  "completedAt": "2025-03-24T10:30:00Z",
  "log": {
    "text": "I felt calm and focused after the meditation."
  },
  "status": "completed"
}
```

### `live_sessions`

```json
{
  "sessionId": "live123",
  "participants": ["abc123", "uid456"],
  "startTime": "2025-03-24T11:00:00Z",
  "endTime": "2025-03-24T11:05:00Z",
  "exerciseId": "silent_eye_contact_001",
  "reflections": [
    {"userId": "abc123", "text": "Felt a sense of calm"},
    {"userId": "uid456", "text": "A bit uncomfortable but interesting"}
  ]
}
```

### `consents`

```json
{
  "userId": "firebase-uid-123",
  "agreedAt": "2025-03-24T10:05:00Z",
  "version": "v1.0"
}
```

### `sessions`

```json
{
  "sessionId": "abc123",
  "callStatus": {
    "verificationCode": "123456",
    "status": "active"
  },
  "userId": "firebase-uid-123"
}
```

## ‚úèÔ∏è Data Entry & Usage

### üå± Onboarding

-   Fields like `birthDate`, `birthTime`, `birthLocation`, and `phoneNumber` from `Steps 1-2` are saved in the `users` collection.
-   Number-based answers from `Step 3` are analyzed to populate `personalityType`, `neuroTendencies`, `wellbeingFlags`, and `answers` in `users`.
-   Consent from `Step 2` is saved in the `consents` collection (see [`Onboarding Process`](#)).

### üí™ Exercises (`activations`)

-   The `exercises` collection is populated with predefined content (see [`Activations: Inner Journey`](#)).
-   The `user_exercises` collection is created/updated when users complete exercises, including logs or AI results.
-   The `live_sessions` collection is created when a live interaction exercise starts and updated with participants and reflections.

### üìû Call Status

-   The `sessions` collection stores temporary data during the call (replaces the current `call_status` dictionary when `Firestore` is implemented).

## üíª Technical Implementation

### üî• Firebase Setup

-   **Firestore:** Used for data storage (collections).
-   **Storage:** Planned for storing media files (audio/video).
-   **Auth:** Planned for user management and authentication.

### üêç Backend Scripts (`FastAPI`)

-   Python logic in `FastAPI` is used for analysis of `birthDate` and `birthTime` (astrology, numerology via `Flatlib`) to populate `personalityType`.

### ü§ñ AI Analysis

-   Onboarding answers are processed by backend logic to generate `personalityType` and `neuroTendencies`.
-   Future "Balance and Body Analysis" exercise will use an external AI service for movement analysis (not implemented).

### üé¨ Live Interactions

-   Integration with a video service (e.g., `WebRTC`) is required for exercises like "Silent Eye Contact Live" (not implemented).

### üîÑ Synchronization

-   Real-time updates via `Firestore` (with listeners in the frontend) will be used to display progress and session status (when implemented).

## üõ°Ô∏è Security & GDPR

-   üîí **Encryption:** Data at rest is automatically encrypted by `Firestore` (standard feature).
-   üîë **Access Control:** Only authenticated users should be able to access their own data via `Firebase Auth` and `Firestore` security rules (planned).
-   üóëÔ∏è **Deletion:** Account deletion functionality must be implemented to clear all related data in `users`, `user_exercises`, `live_sessions`, and `consents`.
-   ‚è≥ **Retention Period for Logs:** Audio/video logs in `Firebase Storage` should be deleted according to a defined policy (e.g., 90 days) if consent is not renewed (planned).
-   For more details on security measures, see [`Security Document`](#).

## üîó Links to Other Documents

This database structure supports features and requirements described in the following documents:

-   [`Project Description: Inner Journey`](#): Enables personalization, logging of exercises, and live interactions.
-   [`User Interface: Inner Journey`](#): Provides data for UI themes (`uiStyle`), display of exercises, and management of live sessions.
-   [`Development Plan: Inner Journey`](#): Implementation of database interactions follows the plan, e.g., basic setup (`Sprint 1`), exercises (`Sprint 4`), live/AI (`Sprint 5`).
-   [`Onboarding Process`](#): Stores input data from the onboarding steps (`Steps 1-3`) and results from new exercise logs.